<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>강의 캘린더</title>
  <style>
    :root {
      --bg: #0b0f17;
      --card: #111827;
      --accent: #2563eb;
      --accent-2: #22c55e;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --grid: #1f2937;
      --danger: #ef4444;
      --today: #334155;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .toolbar { display: flex; align-items: center; gap: 12px; justify-content: space-between; margin-bottom: 16px; }
    .title { font-size: 22px; font-weight: 700; letter-spacing: 0.2px; }
    .controls { display: flex; gap: 8px; align-items: center; }
    button, select { background: var(--card); color: var(--text); border: 1px solid var(--grid); padding: 8px 10px; border-radius: 10px; cursor: pointer; }
    button:hover { border-color: var(--accent); }
    .legend { display: flex; gap: 10px; align-items: center; font-size: 13px; color: var(--muted); }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .dot-accent { background: var(--accent); }
    .dot-accent2 { background: var(--accent-2); }
    .calendar { background: var(--card); border: 1px solid var(--grid); border-radius: 14px; overflow: hidden; }
    .weekday-row, .grid { display: grid; grid-template-columns: repeat(7, 1fr); }
    .weekday { padding: 10px 6px; font-weight: 600; font-size: 12px; text-align: center; color: var(--muted); background: #0f172a; border-bottom: 1px solid var(--grid);
      position: sticky; top: 0; z-index: 5; }
    .cell { min-height: 116px; border-right: 1px solid var(--grid); border-bottom: 1px solid var(--grid); padding: 8px; position: relative; }
    .cell:nth-child(7n) { border-right: 0; }
    .date { font-size: 12px; color: var(--muted); }
    .other-month .date { opacity: 0.4; }
    .today { background: var(--today); }
    .weekend .date { color: #93c5fd; }
    .events { margin-top: 6px; display: flex; flex-direction: column; gap: 4px; }
    .event { font-size: 12px; line-height: 1.3; padding: 4px 6px; border-radius: 8px; border: 1px solid var(--grid); cursor: pointer; background: #0b1220; }
    .event .time { color: var(--muted); margin-right: 4px; }
    .event.primary { outline: 1px solid rgba(37,99,235,.35); background: rgba(37,99,235,.12); }
    .event.secondary { outline: 1px solid rgba(34,197,94,.35); background: rgba(34,197,94,.10); }

    .footer { display: flex; justify-content: space-between; gap: 12px; padding: 12px; font-size: 12px; color: var(--muted); border-top: 1px solid var(--grid); }
    .hint code { background: #0b1220; padding: 2px 6px; border-radius: 6px; border: 1px solid var(--grid); }

    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, .7); display: none; align-items: center; justify-content: center; padding: 16px; }
    .modal { width: min(720px, 96vw); background: var(--card); border: 1px solid var(--grid); border-radius: 16px; padding: 16px; }
    .modal-header { display: flex; justify-content: space-between; align-items: start; gap: 8px; }
    .modal-title { font-weight: 700; font-size: 18px; }
    .badge { font-size: 11px; padding: 2px 6px; border-radius: 999px; border: 1px solid var(--grid); color: var(--muted); }
    .modal-body { margin-top: 8px; line-height: 1.6; color: #d1d5db; }
    .kv { display: grid; grid-template-columns: 96px 1fr; gap: 8px 12px; margin-top: 8px; }
    .kv dt { color: var(--muted); }
    .kv dd { margin: 0; }
    .modal-actions { display: flex; justify-content: end; gap: 8px; margin-top: 16px; }
    .link { text-decoration: none; color: #bfdbfe; }
  </style>
</head>
<body>
<div class="container">
  <div class="toolbar">
    <div class="title" id="title">캘린더</div>
    <div class="controls">
      <button id="prevBtn" aria-label="이전 달">◀</button>
      <select id="monthSelect" aria-label="월 선택"></select>
      <select id="yearSelect" aria-label="연도 선택"></select>
      <button id="nextBtn" aria-label="다음 달">▶</button>
    </div>
  </div>

  <div class="legend">
    <span><span class="dot dot-accent"></span>주요 강의</span>
    <span><span class="dot dot-accent2"></span>일반 강의</span>
  </div>

  <div class="calendar">
    <div class="weekday-row">
      <div class="weekday">일</div>
      <div class="weekday">월</div>
      <div class="weekday">화</div>
      <div class="weekday">수</div>
      <div class="weekday">목</div>
      <div class="weekday">금</div>
      <div class="weekday">토</div>
    </div>
    <div class="grid" id="grid"></div>
    <div class="footer">
      <div class="hint">데이터 파일: <code>events.csv</code> 또는 <code>events.json</code> (동일 폴더). 쿼리스트링으로 교체 가능: <code>?data=path/to/file.csv</code></div>
      <div>오늘: <span id="todayLabel"></span></div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modal">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="mTitle"></div>
        <div style="display:flex; gap:6px; align-items:center; margin-top: 4px;">
          <span class="badge" id="mInstructor"></span>
          <span class="badge" id="mDate"></span>
        </div>
      </div>
      <button id="closeModal">✕</button>
    </div>
    <div class="modal-body">
      <dl class="kv">
        <dt>시간</dt><dd id="mTime"></dd>
        <dt>장소</dt><dd id="mLocation"></dd>
        <dt>유형</dt><dd id="mType"></dd>
        <dt>링크</dt><dd id="mLink"></dd>
      </dl>
      <p id="mDesc" style="margin-top:12px;"></p>
    </div>
    <div class="modal-actions">
      <button id="okBtn">확인</button>
    </div>
  </div>
</div>

<script>
// ===== Config =====
const DEFAULT_DATA_URL = new URLSearchParams(location.search).get('data') || 'events.csv';
const YEAR_RANGE = { min: (new Date()).getFullYear() - 1, max: (new Date()).getFullYear() + 2 };
const PRIMARY_TAGS = ['주요', '메인', '핵심']; // title 또는 type에 포함되면 강조

// CSV 샘플 (리포에 events.csv 파일로 두세요)
/*
"date","title","instructor","start","end","location","type","link","description"
"2025-09-22","쿠팡 구매대행 실전","김민수","20:00","22:00","온라인 라이브","일반","https://example.com/1","신규 셀러 대상 실전 셋업"
"2025-09-22","AI 상세페이지 고급","원카","19:00","21:00","양재 교육장","주요","https://example.com/2","이미지 자동화 + 프롬프트"
"2025-09-25","브랜드 구매대행 입문","홍길동","14:00","16:00","온라인","일반","","처음 시작하는 분 대상"
*/

// ===== Utilities =====
const fmtDate = (d) => new Intl.DateTimeFormat('ko-KR', { dateStyle: 'medium' }).format(d);
const pad = (n) => String(n).padStart(2, '0');

function parseCsv(text) {
  // RFC4180 간단 파서: 쿼트 처리, 줄바꿈 처리
  const rows = [];
  let i = 0, field = '', row = [], inQuotes = false;
  while (i < text.length) {
    const c = text[i];
    if (inQuotes) {
      if (c === '"') {
        if (text[i+1] === '"') { field += '"'; i++; } // 이스케이프 쿼트
        else { inQuotes = false; }
      } else { field += c; }
    } else {
      if (c === '"') inQuotes = true;
      else if (c === ',') { row.push(field.trim()); field = ''; }
      else if (c === '\n' || c === '\r') {
        if (field !== '' || row.length) { row.push(field.trim()); rows.push(row); row = []; field = ''; }
        // CRLF 처리
        if (c === '\r' && text[i+1] === '\n') i++;
      } else { field += c; }
    }
    i++;
  }
  if (field !== '' || row.length) { row.push(field.trim()); rows.push(row); }
  // 헤더 매핑
  const [header, ...data] = rows.filter(r => r.length && r.some(v => v !== ''));
  const idx = Object.fromEntries(header.map((h, j) => [h.toLowerCase(), j]));
  return data.map(r => ({
    date: r[idx.date], title: r[idx.title], instructor: r[idx.instructor], start: r[idx.start], end: r[idx.end],
    location: r[idx.location], type: r[idx.type], link: r[idx.link], description: r[idx.description]
  }));
}

async function loadData(url) {
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error('데이터 로드 실패');
  const ct = res.headers.get('content-type') || '';
  if (ct.includes('application/json') || url.endsWith('.json')) return res.json();
  const text = await res.text();
  return parseCsv(text);
}

function normalizeEvent(e) {
  // 필수: date, title, instructor
  const date = e.date || e.day || e.when;
  const [y,m,dd] = (date||'').split('-').map(Number);
  const start = e.start || '';
  const end = e.end || '';
  const type = e.type || '';
  return {
    y, m, d: dd,
    dateStr: `${y}-${pad(m)}-${pad(dd)}`,
    title: e.title || '(제목 없음)',
    instructor: e.instructor || '',
    start, end,
    location: e.location || '',
    type,
    link: e.link || '',
    description: e.description || '',
    primary: PRIMARY_TAGS.some(t => (type+" "+(e.title||'')).includes(t))
  };
}

function groupByDate(events) {
  const map = new Map();
  for (const ev of events) {
    const key = ev.dateStr;
    if (!map.has(key)) map.set(key, []);
    map.get(key).push(ev);
  }
  // 같은 날짜 내 정렬: 시작시간, 주요도
  for (const arr of map.values()) {
    arr.sort((a,b) => {
      const aa = a.start || '00:00';
      const bb = b.start || '00:00';
      if (aa !== bb) return aa < bb ? -1 : 1;
      if (a.primary !== b.primary) return a.primary ? -1 : 1;
      return a.title.localeCompare(b.title, 'ko');
    });
  }
  return map;
}

// ===== Calendar State =====
const state = {
  today: new Date(),
  cursor: new Date(),
  eventsMap: new Map(),
  raw: []
};

function setupSelectors() {
  const ms = document.getElementById('monthSelect');
  const ys = document.getElementById('yearSelect');
  ms.innerHTML = Array.from({length:12}, (_,i)=>`<option value="${i}">${i+1}월</option>`).join('');
  let yearOpts = '';
  for (let y = YEAR_RANGE.min; y <= YEAR_RANGE.max; y++) yearOpts += `<option value="${y}">${y}년</option>`;
  ys.innerHTML = yearOpts;
  function sync() {
    ms.value = state.cursor.getMonth();
    ys.value = state.cursor.getFullYear();
  }
  sync();
  ms.onchange = () => { state.cursor.setMonth(+ms.value); render(); };
  ys.onchange = () => { state.cursor.setFullYear(+ys.value); render(); };
  document.getElementById('prevBtn').onclick = () => { state.cursor.setMonth(state.cursor.getMonth()-1); render(); sync(); };
  document.getElementById('nextBtn').onclick = () => { state.cursor.setMonth(state.cursor.getMonth()+1); render(); sync(); };
}

function buildGrid(year, month) {
  // month: 0-11
  const first = new Date(year, month, 1);
  const startDay = first.getDay(); // 0 일요일
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const prevDays = startDay; // 이전 달 표시 개수
  const totalCells = Math.ceil((prevDays + daysInMonth) / 7) * 7;

  const cells = [];
  let dayNumPrevMonth = new Date(year, month, 0).getDate() - prevDays + 1;
  // 이전 달
  for (let i=0;i<prevDays;i++) {
    const d = new Date(year, month-1, dayNumPrevMonth++);
    cells.push({ d, other:true });
  }
  // 이번 달
  for (let i=1;i<=daysInMonth;i++) {
    const d = new Date(year, month, i);
    cells.push({ d, other:false });
  }
  // 다음 달
  let i = 1;
  while (cells.length < totalCells) {
    const d = new Date(year, month+1, i++);
    cells.push({ d, other:true });
  }
  return cells;
}

function render() {
  const y = state.cursor.getFullYear();
  const m = state.cursor.getMonth();
  const grid = document.getElementById('grid');
  const title = document.getElementById('title');
  const todayLabel = document.getElementById('todayLabel');
  title.textContent = `${y}년 ${m+1}월 강의 캘린더`;
  todayLabel.textContent = fmtDate(state.today);

  const cells = buildGrid(y, m);
  grid.innerHTML = '';

  for (const c of cells) {
    const div = document.createElement('div');
    div.className = 'cell';
    const dow = c.d.getDay();
    if (dow === 0 || dow === 6) div.classList.add('weekend');
    if (c.other) div.classList.add('other-month');
    if (c.d.toDateString() === state.today.toDateString()) div.classList.add('today');

    const date = document.createElement('div');
    date.className = 'date';
    date.textContent = c.d.getDate();
    div.appendChild(date);

    const evWrap = document.createElement('div');
    evWrap.className = 'events';

    const key = `${c.d.getFullYear()}-${pad(c.d.getMonth()+1)}-${pad(c.d.getDate())}`;
    const events = state.eventsMap.get(key) || [];

    for (const ev of events) {
      const e = document.createElement('div');
      e.className = 'event ' + (ev.primary ? 'primary' : 'secondary');
      e.title = `${ev.title} • ${ev.instructor}`;
      e.innerHTML = `
        ${ev.start ? `<span class="time">${ev.start}</span>`: ''}
        <strong>${ev.title}</strong>
        ${ev.instructor ? ` · ${ev.instructor}` : ''}
      `;
      e.onclick = () => openModal(ev);
      evWrap.appendChild(e);
    }

    div.appendChild(evWrap);
    grid.appendChild(div);
  }
}

function openModal(ev) {
  const $ = (id) => document.getElementById(id);
  $('mTitle').textContent = ev.title;
  $('mInstructor').textContent = ev.instructor || '강사 미정';
  $('mDate').textContent = ev.dateStr;
  $('mTime').textContent = ev.start ? (ev.end ? `${ev.start} ~ ${ev.end}` : ev.start) : (ev.end || '-');
  $('mLocation').textContent = ev.location || '-';
  $('mType').textContent = ev.type || '-';
  $('mDesc').textContent = ev.description || '';
  $('mLink').innerHTML = ev.link ? `<a class="link" href="${ev.link}" target="_blank" rel="noopener">바로가기</a>` : '-';
  const modal = $('modal');
  modal.style.display = 'flex';
  $('closeModal').onclick = () => modal.style.display = 'none';
  $('okBtn').onclick = () => modal.style.display = 'none';
  modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
}

async function boot() {
  setupSelectors();
  try {
    const raw = await loadData(DEFAULT_DATA_URL);
    state.raw = raw;
    const normalized = raw
      .filter(r => r && (r.date || r.day || r.when))
      .map(normalizeEvent)
      .filter(e => e.y && e.m && e.d);
    state.eventsMap = groupByDate(normalized);
  } catch (e) {
    console.warn(e);
    state.eventsMap = new Map();
  }
  render();
}

boot();
</script>
</body>
</html>
