<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Favicon & PWA manifest -->
  <link rel="icon" href="../../assets/icons/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="../../assets/icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../../assets/icons/favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../../assets/icons/apple-touch-icon.png">
  <link rel="manifest" href="../../site.webmanifest">
  <meta name="theme-color" content="#0b1020">
  
  <title>WEBP → PNG/JPG 변환기</title>
  <style>
    :root{--bg:#0b1020;--card:#131a33;--text:#e8ecff;--muted:#a9b0d9;--ring:rgba(110,168,255,.35);}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:32px 16px 64px}
    h1{margin:0 0 8px;font-size:22px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:18px}

    .panel{position:relative;background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.28);padding:18px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0 14px}
    label{font-size:13px;color:var(--muted)}
    select,input[type="range"],button{border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0e1530;color:var(--text)}
    select{padding:8px 10px}
    input[type="range"]{accent-color:#6ea8ff}
    button{cursor:pointer;padding:10px 14px;font-weight:700;border:0;background:#1a2a66}
    button.primary{background:#2b4de0}
    button:disabled{opacity:.6;cursor:not-allowed}

    .drop{margin-top:10px;border:1px dashed rgba(255,255,255,.25);border-radius:14px;padding:18px;text-align:center;color:var(--muted)}
    .drop.drag{outline:3px solid var(--ring);}

    .list{margin-top:14px;display:grid;grid-template-columns:1fr;gap:10px}
    .item{display:flex;gap:12px;align-items:center;justify-content:space-between;background:#0f1633;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 12px}
    .name{font-size:13px;word-break:break-all}
    .thumb{width:36px;height:36px;border-radius:8px;object-fit:cover;background:#000}

    .out{margin-top:18px}
    .out .item{align-items:stretch}
    .dl{display:flex;align-items:center;gap:8px}
    .dl a{color:#cfe1ff;text-decoration:none}
    .small{font-size:12px;color:var(--muted)}

    /* 로딩 오버레이 */
    .busy{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);border-radius:16px}
    .busy.show{display:grid}
    .busy-box{display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:12px;background:#0e1530;border:1px solid rgba(255,255,255,.15)}
    .spinner{width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,.25);border-top-color:#6ea8ff;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<div class="wrap">
  <h1>WEBP → PNG/JPG 변환기</h1>
  <div class="sub">브라우저에서 로컬 변환. 업로드 안 함.</div>

  <div class="panel" id="panel">
    <div class="controls">
      <label>
        출력 형식
        <select id="fmt">
          <option value="image/png">PNG</option>
          <option value="image/jpeg">JPG</option>
        </select>
      </label>
      <label id="qrow" style="display:none">
        JPG 품질 <input id="quality" type="range" min="0.5" max="0.95" step="0.05" value="0.9">
      </label>
      <label id="bgrow" style="display:none">
        배경색(투명 대체)
        <select id="bg">
          <option value="#ffffff">흰색</option>
          <option value="#000000">검정</option>
          <option value="#0b1020">남색</option>
        </select>
      </label>
      <button id="convert" class="primary">선택 파일 변환</button>
      <button id="clear">리셋</button>
      <span id="stats" class="small" style="margin-left:auto"></span>
    </div>

    <div class="drop" id="drop">여기에 WEBP 파일 드롭 또는 <input id="picker" type="file" accept="image/webp" multiple></div>

    <div class="list" id="inList"></div>

    <div class="out" id="out">
      <div class="small">변환 결과</div>
      <div class="list" id="outList"></div>
    </div>

    <!-- 로딩 오버레이 -->
    <div id="busy" class="busy" aria-hidden="true">
      <div class="busy-box"><div class="spinner" aria-hidden="true"></div><div>변환 중…</div></div>
    </div>
  </div>
</div>

<script>
(() => {
  const drop = document.getElementById('drop');
  const picker = document.getElementById('picker');
  const inList = document.getElementById('inList');
  const outList = document.getElementById('outList');
  const stats = document.getElementById('stats');
  const fmt = document.getElementById('fmt');
  const qrow = document.getElementById('qrow');
  const bgrow = document.getElementById('bgrow');
  const quality = document.getElementById('quality');
  const bg = document.getElementById('bg');
  const busy = document.getElementById('busy');
  const convertBtn = document.getElementById('convert');

  let files = [];

  function setBusy(v){
    busy.classList.toggle('show', v);
    // 비활성화: 모든 form 컨트롤
    document.querySelectorAll('button, select, input').forEach(el => el.disabled = v);
    convertBtn.textContent = v ? '변환 중…' : '선택 파일 변환';
  }

  function updateControls(){
    const isJpg = fmt.value === 'image/jpeg';
    qrow.style.display = isJpg ? '' : 'none';
    bgrow.style.display = isJpg ? '' : 'none';
  }
  fmt.addEventListener('change', updateControls);
  updateControls();

  function addFiles(list){
    const before = files.length;
    [...list].forEach(f => {
      if (!/\.webp$/i.test(f.name) && f.type !== 'image/webp') return;
      files.push(f);
    });
    if (files.length === before) return;
    renderInList();
  }

  function renderInList(){
    inList.innerHTML = '';
    files.forEach((f,i) => {
      const url = URL.createObjectURL(f);
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px">
          <img class="thumb" src="${url}" alt="thumb">
          <div class="name">${escapeHtml(f.name)} <span class="small">(${(f.size/1024).toFixed(1)} KB)</span></div>
        </div>
        <button data-idx="${i}" class="one">이 파일만 변환</button>
      `;
      inList.appendChild(el);
    });
    stats.textContent = `파일: ${files.length}`;
  }

  function escapeHtml(s){
    return s.replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]||c));
  }

  drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('drag'); });
  drop.addEventListener('dragleave', () => drop.classList.remove('drag'));
  drop.addEventListener('drop', e => { e.preventDefault(); drop.classList.remove('drag'); addFiles(e.dataTransfer.files); });
  picker.addEventListener('change', e => addFiles(e.target.files));

  document.getElementById('clear').addEventListener('click', () => {
    files = []; inList.innerHTML = ''; outList.innerHTML=''; stats.textContent=''; picker.value='';
  });

  inList.addEventListener('click', async e => {
    if (e.target.classList.contains('one')){
      const btn = e.target; btn.disabled = true; const old = btn.textContent; btn.textContent = '변환 중…';
      const idx = +btn.getAttribute('data-idx');
      try { await convertOne(files[idx]); }
      finally { btn.disabled = false; btn.textContent = old; }
    }
  });

  document.getElementById('convert').addEventListener('click', async () => {
    if (!files.length) return;
    setBusy(true);
    try {
      for (const f of files) await convertOne(f);
    } finally {
      setBusy(false);
    }
  });

  async function convertOne(file){
    const outType = fmt.value;
    const q = parseFloat(quality.value) || 0.9;
    const bgColor = bg.value;

    const bmp = await decodeBitmap(file);
    const canvas = document.createElement('canvas');
    canvas.width = bmp.width; canvas.height = bmp.height;
    const ctx = canvas.getContext('2d');

    if (outType === 'image/jpeg'){
      ctx.fillStyle = bgColor; // JPG는 투명 없음 → 배경 채우기
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }
    ctx.drawImage(bmp, 0, 0);

    const blob = await canvasToBlob(canvas, outType, outType==='image/jpeg' ? q : undefined);
    const url = URL.createObjectURL(blob);

    const outName = file.name.replace(/\.webp$/i, outType==='image/png'?'.png':'.jpg');

    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div class="name">${escapeHtml(outName)} <span class="small">(${(blob.size/1024).toFixed(1)} KB)</span></div>
      <div class="dl">
        <a href="${url}" download="${outName}">다운로드</a>
        <button class="preview">미리보기</button>
      </div>`;

    row.querySelector('.preview').addEventListener('click', () => {
      const w = window.open();
      w.document.write(`<title>${outName}</title>`);
      w.document.write(`<img src="${url}" style="max-width:100%">`);
    });

    outList.appendChild(row);
  }

  async function decodeBitmap(file){
    if ('createImageBitmap' in window){
      return await createImageBitmap(file);
    }
    // Fallback
    return new Promise((res, rej) => {
      const img = new Image();
      img.onload = () => res(img);
      img.onerror = rej;
      img.src = URL.createObjectURL(file);
    });
  }

  function canvasToBlob(canvas, type, quality){
    return new Promise(res => {
      if (canvas.toBlob) canvas.toBlob(b => res(b), type, quality);
      else {
        const data = canvas.toDataURL(type, quality);
        const b = dataURLtoBlob(data);
        res(b);
      }
    });
  }

  function dataURLtoBlob(dataURL){
    const arr = dataURL.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length; const u8 = new Uint8Array(n);
    while(n--) u8[n] = bstr.charCodeAt(n);
    return new Blob([u8], {type:mime});
  }
})();
</script>
</body>
</html>